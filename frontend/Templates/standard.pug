doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title TailorMed Tracking System - Standard
    style.
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f9fb;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(20, 52, 99, 0.15);
      }
      h1 {
        color: #143463;
        text-align: center;
        margin-bottom: 30px;
      }
      .logo {
        display: block;
        max-width: 200px;
        height: auto;
        margin: 0 auto 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #143463;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #97d3df;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #143463;
      }
      button {
        background-color: #143463;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
      }
      button:hover {
        background-color: #0f2849;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 5px;
        display: none;
      }
      .result.success {
        background-color: #e6f4f7; 
        color: #143463;
        border: 1px solid #97d3df;
      }
      .result.error {
        background-color: #ffe6e6;
        border: 1px solid #ff9999;
        color: #cc0000;
      }
      .result.loading {
        background-color: #f0f9fb;
        border: 1px solid #97d3df;
        color: #143463;
      }
      .shipment-info {
        background: #f0f9fb;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border: 1px solid #97d3df;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #d1e8ed;
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        font-weight: 600;
        color: #143463;
      }
      .info-value {
        color: #0f2849;
      }
      .timeline {
        margin-top: 20px;
      }
      .timeline-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        background: #f0f9fb;
      }
      .timeline-item.pending {
        background: #f5f5f5;
        opacity: 0.7;
      }
      .timeline-step {
        background: #97d3df;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-weight: bold;
      }
      .timeline-step.completed {
        background: #143463;
        color: white;
      }
      .timeline-step.completed.order-completed {
        background: #000 !important;
        color: #fff !important;
      }
      .timeline-item.order-completed .timeline-title {
        color: #333 !important;
      }
      .timeline-item.order-completed .timeline-time {
        color: #333 !important;
      }
      .timeline-item.order-completed {
        opacity: 1 !important;
      }
      .timeline-step.active {
        background: #143463;
        color: #fff;
      }
      .timeline-step.pending {
        background: #ccc;
        color: #fff;
      }
      .timeline-step.processing {
        background: #bb2749;
        color: #fff;
      }
      .timeline-step.accent {
        background: #ccc;
        color: #fff;
      }
      .timeline-item.pending {
        opacity: 0.6;
      }
      .timeline-item.processing {
        opacity: 1;
      }
      .timeline-content {
        flex: 1;
      }
      .timeline-title {
        font-weight: 600;
        margin-bottom: 3px;
        color: #143463;
      }
      .timeline-item.pending .timeline-title {
        color: #666;
      }
      .timeline-item.processing .timeline-title {
        color: #bb2749;
      }
      .timeline-item.order-completed .timeline-title {
        color: #333 !important;
      }
      .timeline-time {
        color: #0f2849;
        font-size: 14px;
      }
      .timeline-item.pending .timeline-time {
        color: #999;
      }
      .timeline-item.processing .timeline-time {
        color: #bb2749;
      }
      .timeline-item.order-completed .timeline-time {
        color: #333 !important;
      }
      .timeline-item.event {
        background: #e6f4f7;
        border-left: 4px solid #97d3df;
      }
      .timeline-item.event .timeline-step {
        background: #97d3df;
      }
  body
    .container
      img.logo(src="./images/logo.png", alt="TailorMed")
      
      form#trackingForm
        .form-group
          label(for="orderNo") Job No.
          input#orderNo(type="text", name="orderNo", placeholder="e.g., TM111682", required)
        
        .form-group
          label(for="trackingNo") Tracking No.
          input#trackingNo(type="text", name="trackingNo", placeholder="e.g., GEXVC2YF", required)
        
        button#submitBtn(type="submit") STATUS CHECK
      
      #result.result
        #resultContent
    script.
      const form = document.getElementById('trackingForm');
      const result = document.getElementById('result');
      const resultContent = document.getElementById('resultContent');
      const submitBtn = document.getElementById('submitBtn');

      // Read API Key from URL (if provided)
      const urlParams = new URLSearchParams(window.location.search);
      const apiKey = urlParams.get('apiKey');
      
      if (apiKey) {
        console.log('âœ… API Key detected - Enhanced rate limit active');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const orderNo = document.getElementById('orderNo').value.trim().toUpperCase();
        const trackingNo = document.getElementById('trackingNo').value.trim().toUpperCase();
        
        if (!orderNo || !trackingNo) {
          showError('Please enter both Job No. and Tracking No.');
          return;
        }
        
        await fetchTrackingData(orderNo, trackingNo);
      });

      async function fetchTrackingData(orderNo, trackingNo) {
        showLoading('Checking shipment status, please wait...');
        
        try {
          // æª¢æ¸¬ç’°å¢ƒï¼šå¦‚æœæ˜¯ localhost ä½¿ç”¨æœ¬åœ° API æœå‹™å™¨ï¼Œå¦å‰‡ä½¿ç”¨ Netlify Function
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const apiBaseUrl = isLocalhost ? 'http://localhost:3001/api' : '/api';
          
          // Build API URL, append API Key if available
          let apiUrl = `${apiBaseUrl}/tracking?orderNo=${encodeURIComponent(orderNo)}&trackingNo=${encodeURIComponent(trackingNo)}`;
          if (apiKey) {
            apiUrl += `&apiKey=${encodeURIComponent(apiKey)}`;
          }
          
          console.log('ğŸ” API URL:', apiUrl);
          
          // æ·»åŠ è¶…æ™‚è¨­ç½®ï¼ˆ30ç§’ï¼‰
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000);
          
          try {
            const response = await fetch(apiUrl, {
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
              if (response.status === 404) {
                showError('No record found. Please verify the tracking number.');
                return;
              }
              if (response.status === 429) {
                const errorData = await response.json();
                showError(errorData.message || 'Query limit reached (10 per hour). Please try again later.');
                return;
              }
              throw new Error(`Network response was not ok: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('âœ… API å›æ‡‰æˆåŠŸ:', data.success);
            
            if (data.success && data.data) {
              showSuccess(data.data);
            } else {
              showError('Query failed. Please try again later.');
            }
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
              console.error('â±ï¸ è«‹æ±‚è¶…æ™‚');
              showError('Request timeout. Please try again.');
            } else {
              throw fetchError;
            }
          }
          
        } catch (error) {
          console.error('âŒ Query error:', error);
          showError('Service temporarily unavailable. Please try again later or contact support.');
        }
      }

      function showLoading(message) {
        result.className = 'result loading';
        resultContent.innerHTML = `<p>${message}</p>`;
        result.style.display = 'block';
        submitBtn.disabled = true;
      }

      function showError(message) {
        result.className = 'result error';
        resultContent.innerHTML = `<p>${message}</p>`;
        result.style.display = 'block';
        submitBtn.disabled = false;
      }

      // æ ¼å¼åŒ– Last Update ç‚ºå°ç£æ™‚é–“ï¼ˆæ ¼å¼ï¼šM/D/YYYY HH:MMï¼‰
      function formatLastUpdate(lastUpdate) {
        if (!lastUpdate) return 'â€”';
        
        try {
          const date = new Date(lastUpdate);
          if (isNaN(date.getTime())) return lastUpdate; // å¦‚æœä¸æ˜¯æœ‰æ•ˆæ—¥æœŸï¼Œè¿”å›åŸå€¼
          
          // ä½¿ç”¨ Intl.DateTimeFormat æ ¼å¼åŒ–ç‚ºå°ç£æ™‚å€ï¼ˆUTC+8ï¼‰
          const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
          });
          
          const parts = formatter.formatToParts(date);
          const month = parts.find(p => p.type === 'month').value;
          const day = parts.find(p => p.type === 'day').value;
          const year = parts.find(p => p.type === 'year').value;
          const hours = parts.find(p => p.type === 'hour').value;
          const minutes = parts.find(p => p.type === 'minute').value;
          
          return `${month}/${day}/${year} ${hours}:${minutes}`;
        } catch (e) {
          return lastUpdate; // å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›åŸå€¼
        }
      }

      function showSuccess(shipmentData) {
        result.className = 'result success';
        
        let timelineHtml = '';
        // æ ¹æ“š Transport Type æ±ºå®šé¡¯ç¤ºé‚è¼¯ï¼ˆåœ¨æª¢æŸ¥ timeline ä¹‹å‰å…ˆåˆ¤æ–·ï¼‰
        const transportType = (shipmentData.transportType || '').trim();
        const isDomestic = transportType.toLowerCase() === 'domestic';
        
        // å¦‚æœæ˜¯ Domesticï¼Œåªé¡¯ç¤º 4 å€‹æ­¥é©Ÿï¼Œæ’é™¤äº‹ä»¶
        const domesticSteps = [
          'Order Created',
          'Shipment Collected',
          'In Transit',
          'Shipment Delivered'
        ];
        
        // éæ¿¾ timeline é …ç›®
        let filteredTimeline = [];
        console.log('ğŸ” Transport Type åˆ¤æ–·:', { transportType, isDomestic });
        if (shipmentData.timeline && shipmentData.timeline.length > 0) {
          console.log('ğŸ“‹ åŸå§‹ Timeline é …ç›®æ•¸:', shipmentData.timeline.length);
          if (isDomestic) {
            // Domesticï¼šåªé¡¯ç¤º 4 å€‹æ­¥é©Ÿï¼Œæ’é™¤æ‰€æœ‰äº‹ä»¶
            filteredTimeline = shipmentData.timeline.filter(item => {
              if (item.isEvent) return false; // æ’é™¤æ‰€æœ‰äº‹ä»¶
              const itemTitleLower = item.title.toLowerCase().trim();
              const isMatch = domesticSteps.some(step => {
                const stepLower = step.toLowerCase().trim();
                return itemTitleLower === stepLower || 
                       itemTitleLower.includes(stepLower) ||
                       stepLower.includes(itemTitleLower.replace(/\s+/g, ''));
              });
              return isMatch;
            });
            console.log('âœ… Domestic éæ¿¾å¾Œé …ç›®æ•¸:', filteredTimeline.length);
            filteredTimeline.forEach(item => console.log('  -', item.title));
          } else {
            // Export/Import/Crossï¼šé¡¯ç¤ºæ‰€æœ‰é …ç›®ï¼ˆåŒ…æ‹¬äº‹ä»¶ï¼‰
            filteredTimeline = shipmentData.timeline;
            console.log('âœ… Export/Import/Cross - é¡¯ç¤ºæ‰€æœ‰é …ç›®');
          }
        }
        
        if (filteredTimeline.length > 0) {
          timelineHtml = '<div class="timeline"><h3>TIMELINE</h3>';
          
          // é‡æ–°ç·¨è™Ÿæ­¥é©Ÿï¼ˆäº‹ä»¶ä¸ç·¨è™Ÿï¼‰
          let stepCounter = 1;
          filteredTimeline.forEach((item) => {
            if (!item.isEvent) {
              item.displayStep = stepCounter++;
            }
          });
          
          filteredTimeline.forEach(item => {
            // For Standard version, show all items but mark events differently
            const stepClass = item.status || 'pending';
            const stepDisplay = item.displayStep || item.step || 1;
            
            // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“é¡¯ç¤º
            // å¦‚æœæ²’æœ‰æ—¥æœŸæ™‚é–“ï¼Œé¡¯ç¤º "Pending..."
            let dateTimeDisplay = '';
            // æª¢æŸ¥ date å’Œ time æ˜¯å¦å­˜åœ¨ä¸”ä¸ç‚ºç©ºå­—ä¸²
            const hasDate = item.date && item.date.trim() !== '';
            const hasTime = item.time && item.time.trim() !== '';
            
            if (hasDate && hasTime) {
              // æ ¼å¼åŒ–æ—¥æœŸï¼šYYYY-MM-DD â†’ YYYY/MM/DD
              const formattedDate = item.date.replace(/-/g, '/');
              dateTimeDisplay = `${formattedDate} ${item.time}`;
            } else if (hasDate) {
              dateTimeDisplay = item.date.replace(/-/g, '/');
            } else if (hasTime) {
              dateTimeDisplay = item.time;
            } else {
              // å¦‚æœæ˜¯è™•ç†ä¸­ç‹€æ…‹ï¼Œé¡¯ç¤º "Processing..."ï¼›å¦å‰‡é¡¯ç¤º "Pending..."
              dateTimeDisplay = item.status === 'processing' ? 'Processing...' : 'Pending...';
            }
            
            // Handle events
            if (item.isEvent) {
              timelineHtml += `
                <div class="timeline-item event">
                  <div class="timeline-step">â—</div>
                  <div class="timeline-content">
                    <div class="timeline-title">${item.title}</div>
                    <div class="timeline-time">${dateTimeDisplay}</div>
                  </div>
                </div>
              `;
            } else {
              // æª¢æŸ¥æ˜¯å¦ç‚ºè¨‚å–®å®Œæˆç‹€æ…‹
              const isOrderCompleted = item.isOrderCompleted === true;
              // æ ¹æ“šç‹€æ…‹æ±ºå®šæ¨£å¼ï¼šprocessing ä½¿ç”¨ processing æ¨£å¼ï¼Œpending ä½¿ç”¨ç°éšæ¨£å¼ï¼Œè¨‚å–®å®Œæˆä½¿ç”¨ç‰¹æ®Šæ¨£å¼
              const stepClassForStatus = item.status === 'processing' ? 'processing' : 
                                        (item.status === 'pending' ? 'pending' : 
                                        (isOrderCompleted ? 'completed order-completed' : stepClass));
              const stepColorClass = item.status === 'processing' ? 'processing' : 
                                    (item.status === 'pending' ? 'pending' : 
                                    (isOrderCompleted ? 'completed order-completed' : item.status));
              const itemClass = isOrderCompleted ? 'order-completed' : 
                               (item.status === 'processing' ? 'processing' : 
                                item.status === 'pending' ? 'pending' : '');
              
              // Regular timeline step
              timelineHtml += `
                <div class="timeline-item ${itemClass} ${stepClassForStatus}">
                  <div class="timeline-step ${stepColorClass}">${stepDisplay}</div>
                  <div class="timeline-content">
                    <div class="timeline-title">${item.title}</div>
                    <div class="timeline-time">${dateTimeDisplay}</div>
                  </div>
                </div>
              `;
            }
          });
          
          timelineHtml += '</div>';
        }
        
        // æ‰¾å‡º timeline ä¸­ç‹€æ…‹ç‚º processing çš„å‰ä¸€å€‹æ­¥é©Ÿæ¨™é¡Œï¼Œç”¨æ–¼é¡¯ç¤º Status
        let statusDisplay = shipmentData.status || 'â€”';
        // ä½¿ç”¨éæ¿¾å¾Œçš„ timelineï¼ˆfilteredTimelineï¼‰ä¾†åˆ¤æ–· Status
        const timelineForStatus = filteredTimeline || shipmentData.timeline || [];
        if (timelineForStatus.length > 0) {
          const processingIndex = timelineForStatus.findIndex(item => item.status === 'processing');
          if (processingIndex >= 0 && processingIndex > 0) {
            // æ‰¾åˆ° processing çš„å‰ä¸€å€‹æ­¥é©Ÿï¼ˆæ’é™¤äº‹ä»¶ï¼‰
            for (let i = processingIndex - 1; i >= 0; i--) {
              if (!timelineForStatus[i].isEvent) {
                statusDisplay = timelineForStatus[i].title;
                break;
              }
            }
          }
        }
        
        resultContent.innerHTML = `
          <h3>SUCCESS</h3>
          <div class="shipment-info">
            <div class="info-row">
              <span class="info-label">Job No.</span>
              <span class="info-value">${shipmentData.orderNo || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Tracking No.</span>
              <span class="info-value">${shipmentData.trackingNo || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Invoice No.</span>
              <span class="info-value">${shipmentData.invoiceNo || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ETA</span>
              <span class="info-value">${shipmentData.eta || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status</span>
              <span class="info-value">${statusDisplay}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Update</span>
              <span class="info-value">${formatLastUpdate(shipmentData.lastUpdate)}</span>
            </div>
          </div>
          ${timelineHtml}
        `;
        
        result.style.display = 'block';
        submitBtn.disabled = false;
      }

      // Auto-fill test data
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('orderNo').value = 'TM111668';
        document.getElementById('trackingNo').value = 'EU5CET6N';
      });
