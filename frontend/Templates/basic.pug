doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title TailorMed Tracking System
    style.
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #efefef;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .logo {
        display: block;
        max-width: 200px;
        height: auto;
        margin: 0 auto 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #d28c00;
      }
      button {
        background-color: #333;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
      }
      button:hover {
        background-color: #111;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 5px;
        display: none;
      }
      .result.success {
        background-color: #cfcfcf; 
        color: #333;
      }
      .result.error {
        background-color: #cfcfcf;
        border: 1px solid #afafaf;
        color: #393939;
      }
      .result.loading {
        background-color: #efefef;
        border: 1px solid #bfbfbf;
        color: #999;
      }
      .shipment-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        font-weight: 600;
        color: #495057;
      }
      .info-value {
        color: #6c757d;
      }
      .timeline {
        margin-top: 20px;
      }
      .timeline-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        background: #f8f9fa;
      }
      .timeline-item.pending {
        background: #f0f0f0;
        opacity: 0.7;
      }
      .timeline-step {
        background: #ccc;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-weight: bold;
      }
      .timeline-step.completed {
        background: #333;
        color: white;
      }
      .timeline-step.completed.order-completed {
        background: #000 !important;
        color: #fff !important;
      }
      .timeline-item.order-completed .timeline-title {
        color: #333 !important;
      }
      .timeline-item.order-completed .timeline-time {
        color: #333 !important;
      }
      .timeline-item.order-completed {
        opacity: 1 !important;
      }
      .timeline-step.active {
        background: #d28c00;
        color: #fff;
      }
      .timeline-step.pending {
        background: #ccc;
        color: #fff;
      }
      .timeline-step.processing {
        background: #bb2749;
        color: #fff;
      }
      .timeline-step.accent {
        background: #ccc;
        color: #fff;
      }
      .timeline-item.pending {
        opacity: 0.6;
      }
      .timeline-item.processing {
        opacity: 1;
      }
      .timeline-content {
        flex: 1;
      }
      .timeline-title {
        font-weight: 600;
        margin-bottom: 3px;
      }
      .timeline-item.pending .timeline-title {
        color: #666;
      }
      .timeline-item.processing .timeline-title {
        color: #bb2749;
      }
      .timeline-item.order-completed .timeline-title {
        color: #333 !important;
      }
      .timeline-time {
        color: #6c757d;
        font-size: 14px;
      }
      .timeline-item.pending .timeline-time {
        color: #999;
      }
      .timeline-item.processing .timeline-time {
        color: #bb2749;
      }
      .timeline-item.order-completed .timeline-time {
        color: #333 !important;
      }
      .timeline-item.event {
        background: #efefef;
        border-left: 4px solid #ccc;
      }
      .timeline-item.event .timeline-step {
        background: #ccc;
      }
  body
    .container
      img.logo(src="./images/logo.png", alt="TailorMed")
      
      form#trackingForm
        .form-group
          label(for="orderNo") Job No.
          input#orderNo(type="text", name="orderNo", placeholder="e.g., TM111682", required)
        
        .form-group
          label(for="trackingNo") Tracking No.
          input#trackingNo(type="text", name="trackingNo", placeholder="e.g., GEXVC2YF", required)
        
        button#submitBtn(type="submit") STATUS CHECK
      
      #result.result
        #resultContent
    script.
      const form = document.getElementById('trackingForm');
      const result = document.getElementById('result');
      const resultContent = document.getElementById('resultContent');
      const submitBtn = document.getElementById('submitBtn');

      // Read API Key from URL (if provided)
      const urlParams = new URLSearchParams(window.location.search);
      const apiKey = urlParams.get('apiKey');
      
      if (apiKey) {
        console.log('âœ… API Key detected - Enhanced rate limit active');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const orderNo = document.getElementById('orderNo').value.trim().toUpperCase();
        const trackingNo = document.getElementById('trackingNo').value.trim().toUpperCase();
        
        if (!orderNo || !trackingNo) {
          showError('Please enter both Job No. and Tracking No.');
          return;
        }
        
        await fetchTrackingData(orderNo, trackingNo);
      });

      async function fetchTrackingData(orderNo, trackingNo) {
        showLoading('Checking shipment status, please wait...');
        
        try {
          // æª¢æ¸¬ç’°å¢ƒï¼šå¦‚æœæ˜¯ localhost ä½¿ç”¨æœ¬åœ° API æœå‹™å™¨ï¼Œå¦å‰‡ä½¿ç”¨ Netlify Function
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const apiBaseUrl = isLocalhost ? 'http://localhost:3001/api' : '/api';
          
          // Build API URL, append API Key if available
          let apiUrl = `${apiBaseUrl}/tracking?orderNo=${encodeURIComponent(orderNo)}&trackingNo=${encodeURIComponent(trackingNo)}`;
          if (apiKey) {
            apiUrl += `&apiKey=${encodeURIComponent(apiKey)}`;
          }
          
          console.log('ğŸ” API URL:', apiUrl);
          
          // æ·»åŠ è¶…æ™‚è¨­ç½®ï¼ˆ30ç§’ï¼‰
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000);
          
          try {
            const response = await fetch(apiUrl, {
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
              if (response.status === 404) {
                showError('No record found. Please verify the tracking number.');
                return;
              }
              if (response.status === 429) {
                const errorData = await response.json();
                showError(errorData.message || 'Query limit reached (10 per hour). Please try again later.');
                return;
              }
              throw new Error(`Network response was not ok: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('âœ… API å›æ‡‰æˆåŠŸ:', data.success);
            
            if (data.success && data.data) {
              showSuccess(data.data);
            } else {
              showError('Query failed. Please try again later.');
            }
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
              console.error('â±ï¸ è«‹æ±‚è¶…æ™‚');
              showError('Request timeout. Please try again.');
            } else {
              throw fetchError;
            }
          }
          
        } catch (error) {
          console.error('âŒ Query error:', error);
          showError('Service temporarily unavailable. Please try again later or contact support.');
        }
      }

      function showLoading(message) {
        result.className = 'result loading';
        resultContent.innerHTML = `<p>${message}</p>`;
        result.style.display = 'block';
        submitBtn.disabled = true;
      }

      function showError(message) {
        result.className = 'result error';
        resultContent.innerHTML = `<p>${message}</p>`;
        result.style.display = 'block';
        submitBtn.disabled = false;
      }

      // æ ¼å¼åŒ– Last Update ç‚ºå°ç£æ™‚é–“ï¼ˆæ ¼å¼ï¼šM/D/YYYY HH:MMï¼‰
      function formatLastUpdate(lastUpdate) {
        if (!lastUpdate) return 'â€”';
        
        try {
          const date = new Date(lastUpdate);
          if (isNaN(date.getTime())) return lastUpdate; // å¦‚æœä¸æ˜¯æœ‰æ•ˆæ—¥æœŸï¼Œè¿”å›åŸå€¼
          
          // ä½¿ç”¨ Intl.DateTimeFormat æ ¼å¼åŒ–ç‚ºå°ç£æ™‚å€ï¼ˆUTC+8ï¼‰
          const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: 'Asia/Taipei',
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
          });
          
          const parts = formatter.formatToParts(date);
          const month = parts.find(p => p.type === 'month').value;
          const day = parts.find(p => p.type === 'day').value;
          const year = parts.find(p => p.type === 'year').value;
          const hours = parts.find(p => p.type === 'hour').value;
          const minutes = parts.find(p => p.type === 'minute').value;
          
          return `${month}/${day}/${year} ${hours}:${minutes}`;
        } catch (e) {
          return lastUpdate; // å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›åŸå€¼
        }
      }

      function showSuccess(shipmentData) {
        result.className = 'result success';
        
        let timelineHtml = '';
        if (shipmentData.timeline && shipmentData.timeline.length > 0) {
          timelineHtml = '<div class="timeline"><h3>TIMELINE</h3>';
          
          // Basic version åªé¡¯ç¤º 4 å€‹åŸºæœ¬æ­¥é©Ÿï¼ˆæ’é™¤äº‹ä»¶ï¼‰
          // æŒ‰ç…§ç”¨æˆ¶æŒ‡å®šçš„é †åºï¼šOrder Created, Shipment Collected, In Transit, Shipment Delivered
          const basicSteps = [
            'Order Created',
            'Shipment Collected',
            'In Transit',
            'Shipment Delivered'
          ];
          
          // Filter and show only basic steps (æ’é™¤äº‹ä»¶)
          let stepCounter = 1;
          const filteredItems = [];
          
          shipmentData.timeline.forEach(item => {
            // æ’é™¤äº‹ä»¶ï¼ˆisEventï¼‰
            if (item.isEvent) {
              return; // Skip events
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºåŸºæœ¬æ­¥é©Ÿ
            const itemTitleLower = item.title.toLowerCase().trim();
            const isBasicStep = basicSteps.some(step => {
              const stepLower = step.toLowerCase().trim();
              return itemTitleLower === stepLower || 
                     itemTitleLower.includes(stepLower) ||
                     stepLower.includes(itemTitleLower.replace(/\s+/g, ''));
            });
            
            if (isBasicStep) {
              filteredItems.push({
                ...item,
                newStepNumber: stepCounter++
              });
            }
          });
          
          // å¦‚æœæ²’æœ‰éæ¿¾åˆ°ä»»ä½•é …ç›®ï¼Œé¡¯ç¤ºæ‰€æœ‰éäº‹ä»¶çš„é …ç›®ï¼ˆé™¤éŒ¯ç”¨ï¼‰
          if (filteredItems.length === 0 && shipmentData.timeline.length > 0) {
            console.log('âš ï¸ æ²’æœ‰åŒ¹é…åˆ°åŸºæœ¬æ­¥é©Ÿï¼Œé¡¯ç¤ºæ‰€æœ‰éäº‹ä»¶ timeline é …ç›®:', shipmentData.timeline.map(i => i.title));
            shipmentData.timeline.forEach(item => {
              if (!item.isEvent) {
                filteredItems.push({
                  ...item,
                  newStepNumber: stepCounter++
                });
              }
            });
          }
          
          // ä¿æŒ API è¿”å›çš„é †åºï¼ˆæŒ‰ç…§ç”¨æˆ¶æŒ‡å®šçš„é †åºï¼‰ï¼Œä¸é‡æ–°æ’åº
          // ä¸éœ€è¦æ’åºï¼Œç›´æ¥ä½¿ç”¨å¾ API è¿”å›çš„é †åº
          
          // Display renumbered steps
          filteredItems.forEach(item => {
            const stepClass = item.status;
            const stepDisplay = item.newStepNumber; // Use new numbering 1-6
            
            // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“é¡¯ç¤º
            // å¦‚æœæ²’æœ‰æ—¥æœŸæ™‚é–“ï¼Œé¡¯ç¤º "Pending..."
            let dateTimeDisplay = '';
            // æª¢æŸ¥ date å’Œ time æ˜¯å¦å­˜åœ¨ä¸”ä¸ç‚ºç©ºå­—ä¸²
            const hasDate = item.date && item.date.trim() !== '';
            const hasTime = item.time && item.time.trim() !== '';
            
            if (hasDate && hasTime) {
              // æ ¼å¼åŒ–æ—¥æœŸï¼šYYYY-MM-DD â†’ YYYY/MM/DD
              const formattedDate = item.date.replace(/-/g, '/');
              dateTimeDisplay = `${formattedDate} ${item.time}`;
            } else if (hasDate) {
              dateTimeDisplay = item.date.replace(/-/g, '/');
            } else if (hasTime) {
              dateTimeDisplay = item.time;
            } else {
              // å¦‚æœæ˜¯è™•ç†ä¸­ç‹€æ…‹ï¼Œé¡¯ç¤º "Processing..."ï¼›å¦å‰‡é¡¯ç¤º "Pending..."
              dateTimeDisplay = item.status === 'processing' ? 'Processing...' : 'Pending...';
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè¨‚å–®å®Œæˆç‹€æ…‹
            const isOrderCompleted = item.isOrderCompleted === true;
            // æ ¹æ“šç‹€æ…‹æ±ºå®šæ¨£å¼ï¼šprocessing ä½¿ç”¨ processing æ¨£å¼ï¼Œpending ä½¿ç”¨ç°éšæ¨£å¼ï¼Œè¨‚å–®å®Œæˆä½¿ç”¨ç‰¹æ®Šæ¨£å¼
            const stepClassForStatus = item.status === 'processing' ? 'processing' : 
                                      (item.status === 'pending' ? 'pending' : 
                                      (isOrderCompleted ? 'completed order-completed' : stepClass));
            const stepColorClass = item.status === 'processing' ? 'processing' : 
                                  (item.status === 'pending' ? 'pending' : 
                                  (isOrderCompleted ? 'completed order-completed' : item.status));
            const itemClass = isOrderCompleted ? 'order-completed' : 
                             (item.status === 'processing' ? 'processing' : 
                              item.status === 'pending' ? 'pending' : '');
            
            timelineHtml += `
              <div class="timeline-item ${itemClass} ${stepClassForStatus}">
                <div class="timeline-step ${stepColorClass}">${stepDisplay}</div>
                <div class="timeline-content">
                  <div class="timeline-title">${item.title}</div>
                  <div class="timeline-time">${dateTimeDisplay}</div>
                </div>
              </div>
            `;
          });
          timelineHtml += '</div>';
        }
        
        // æ‰¾å‡º timeline ä¸­ç‹€æ…‹ç‚º processing çš„å‰ä¸€å€‹æ­¥é©Ÿæ¨™é¡Œï¼Œç”¨æ–¼é¡¯ç¤º Status
        let statusDisplay = shipmentData.status || 'â€”';
        if (shipmentData.timeline && shipmentData.timeline.length > 0) {
          const processingIndex = shipmentData.timeline.findIndex(item => item.status === 'processing');
          if (processingIndex >= 0 && processingIndex > 0) {
            // æ‰¾åˆ° processing çš„å‰ä¸€å€‹æ­¥é©Ÿï¼ˆæ’é™¤äº‹ä»¶ï¼‰
            for (let i = processingIndex - 1; i >= 0; i--) {
              if (!shipmentData.timeline[i].isEvent) {
                statusDisplay = shipmentData.timeline[i].title;
                break;
              }
            }
          }
        }
        
        resultContent.innerHTML = `
          <h3>SUCCESS</h3>
          <div class="shipment-info">
            <div class="info-row">
              <span class="info-label">Job No.</span>
              <span class="info-value">${shipmentData.orderNo || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Tracking No.</span>
              <span class="info-value">${shipmentData.trackingNo || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Invoice No.</span>
              <span class="info-value">${shipmentData.invoiceNo || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ETA</span>
              <span class="info-value">${shipmentData.eta || 'â€”'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Status</span>
              <span class="info-value">${statusDisplay}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last Update</span>
              <span class="info-value">${formatLastUpdate(shipmentData.lastUpdate)}</span>
            </div>
          </div>
          ${timelineHtml}
        `;
        
        result.style.display = 'block';
        submitBtn.disabled = false;
      }

      // Auto-fill test data
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('orderNo').value = 'TM111695';
        document.getElementById('trackingNo').value = 'X73K1UN6';
      });
